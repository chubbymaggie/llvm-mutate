#!/bin/bash
#
# llvm-mutate -[n|l|g|G] -[c|i|s instructions] -l -[o path]
#  mutate llvm assembly code
#
# Options
#  -C,--count ------ print the number of instructions
#  -L,--list ------- list instructions with number and types
#  -g,--cfg -------- show the CFG graph
#  -G,--call-graph - show the call graph
#  -c,--cut -------- cut the given instruction
#  -i,--insert ----- copy the second inst. before the first
#  -s,--swap ------- swap the given instructions
#  -l,--link ------- link the result into an executable
#  -o,--out -------- write output to specified file
#
HELP_TEXT=$(cat "$0" \
    |sed '/^[^#]/q' \
    |head -n -1 \
    |tail -n +3 \
    |sed -e :a -e '/^\n*$/{$d;N;ba' -e '}' \
    |cut -c3-)
if echo "$1"|grep -q "\-h";then
    echo "$HELP_TEXT"; exit 1;
fi
LEVEL="../../.."
OPT_FLAGS="-load ${LEVEL}/Debug+Asserts/lib/Mutate.so -f"
LINK=""
OUT=""
RAW=$(cat -)

run(){ RAW="$(echo "$RAW"|opt ${OPT_FLAGS} $@|llvm-dis)"; }

## Process Options
eval set -- $(getopt \
    -o hCLgGc:i:s:lo:f: \
    -l help,count,cfg,call-graph,list,cut:,insert:,swap:,link,out:,file: \
    -- "$@" || echo "$HELP_TEXT" && exit 1;)
while [ $# -gt 0 ];do
    case $1 in
        -h|--help) echo "$HELP_TEXT" && exit 1;;
        -l|--link) LINK="yes";;
        -o|--out)  OUT="$2"; shift;;
        -f|--file) FILE="$2"; shift;;
        -C|--count) run -count ;;
        -L|--list)  run -list ;;
        -g|--cfg)
            for graph in $(run -dot-cfg 3>&1 >/dev/null 2>&3 \
                |sed "s/Writing '//;s/'...//");do
                cat $graph|dot -Tpng|feh -
                rm -f $graph
            done
            ;;
        -G|--call-graph)
            for graph in $(run -dot-callgraph 3>&1 >/dev/null 2>&3 \
                |sed "s/Writing '//;s/'...//");do
                cat $graph|dot -Tpng|feh -
                rm -f $graph
            done
            ;;
        -c|--cut)   run -cut -inst1="$2"; shift;;
        -i|--insert)
            run -insert \
                -inst1="$(echo $2|cut -d, -f1)" \
                -inst2="$(echo $2|cut -d, -f2)"; shift;;
        -s|--swap)
            run -swap \
                -inst1="$(echo $2|cut -d, -f1)" \
                -inst2="$(echo $2|cut -d, -f2)"; shift;;
        (--) shift; break;;
        (-*) error "unrecognized option $1";;
        (*)  break;;
    esac
    shift
done

if [ ! -z "$LINK" ];then
    if [ -z "$OUT" ];then OUT=a.out; fi
    echo "$RAW"|llc|clang -x assembler - -o $OUT
else
    if [ -z "$OUT" ];then OUT=/dev/stdout; fi
    echo "$RAW" > $OUT
fi
